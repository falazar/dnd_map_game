<html>
<head>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        #map {
            height: 2048px; /* Double the original height */
            width: 2048px; /* Double the original width */
            background-image: url('images/grass2.jpg');
            background-size: 1024px 1024px; /* Size of one tile */
            background-repeat: repeat; /* Repeat the background image */
            background-position: top left;
            z-index: 1; /* Set z-index for map */
        }

        #guard1 {
            position: absolute;
            background-image: url('images/guard1.png');
            background-size: cover;
            background-position: center;
            top: 700px;
            left: 700px;
            width: 120px;
            height: 120px;
            /*border-radius: 50%;*/
            z-index: 10; /* Set z-index for guard, higher is top */
        }

        .object-style {
            position: absolute;
            background-size: cover;
            background-position: center;
            z-index: 5; /* Set z-index for building and objects. */
        }

    </style>

    <script>
      function handleKeydown(event) {
        const guard = document.getElementById('guard1');
        const step = 10; // Number of pixels to move
        let top = parseInt(guard.style.top);
        let left = parseInt(guard.style.left);

        console.log("\nDEBUG key = " + event.key + ", top = " + top + ", left = " + left);

        switch (event.key) {
          case 'ArrowUp':
            guard.style.top = (top - step) + 'px';
            event.preventDefault();
            break;
          case 'ArrowDown':
            guard.style.top = (top + step) + 'px';
            event.preventDefault();
            break;
          case 'ArrowLeft':
            guard.style.left = (left - step) + 'px';
            event.preventDefault();
            break;
          case 'ArrowRight':
            guard.style.left = (left + step) + 'px';
            event.preventDefault();
            break;
        }

        // Update z-index based on position, put person behind a house.
        const guardBottom = parseInt(guard.style.top) + guard.offsetHeight;
        console.log("DEBUG guardBottom = " + guardBottom);

        // TODO: maybe dont do this EVERY time, only map load...
        const objects = document.querySelectorAll('.object-style'); // Define objects here
        objects.forEach(object => {
          if (!isTouching(guard, object)) {
            return;
          }

          // TODO if touching only.
          const midline = parseInt(object.style.top) + parseInt(object.getAttribute('data-midline'));
          console.log("DEBUG object id = " + object.id + ", midline = " + midline);

          if (guardBottom < midline) {
            console.log("DEBUG pushing behind object")
            // guard.style.zIndex = 5; // Behind the object
            const computedStyle = window.getComputedStyle(object);
            const objectZIndex = parseInt(computedStyle.zIndex);
            guard.style.zIndex = objectZIndex - 1; // Behind the object
            console.log("DEBUG object.style.zIndex = " + objectZIndex);
            console.log("DEBUG guard.style.zIndex = " + guard.style.zIndex);
          } else {
            console.log("DEBUG pulling in front of object")
            guard.style.zIndex = 10; // In front of the object
          }
        });
      }

      function isTouching(guard, object) {
        const guardRect = guard.getBoundingClientRect();
        const objectRect = object.getBoundingClientRect();

        return !(
          guardRect.top > objectRect.bottom ||
          guardRect.bottom < objectRect.top ||
          guardRect.left > objectRect.right ||
          guardRect.right < objectRect.left
        );
      }

      // Listeners.
      document.addEventListener('keydown', handleKeydown);
    </script>
</head>
<body>
<!-- todo move everyone into the map div? -->
<div id="map"></div>

<div id="guard1" style="top: 700px; left: 700px;"></div>

<!--test lets add in a couple houses-->
<!-- todo need to shrink and remove extra spaces around houses. -->
<div id="house2" class="object-style" style="top: 100px; left: 100px; width: 600px; height: 600px; background-image: url('images/house6.png');" data-midline="450"></div>
<div id="house1" class="object-style" style="top: 100px; left: 800px; width: 600px; height: 600px; background-image: url('images/house5.png');" data-midline="450"></div>

</body>
</html>